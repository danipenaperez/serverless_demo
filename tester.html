<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>JS Bin</title>
  <script src="https://code.jquery.com/jquery-3.4.1.js"  integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
</head>
<body>
    <h1>Authentication</h1>

      <table >
        <tr>
          <th colspan=2>LOGIN</th>
        </tr>
        <tr>
          <td>UserName:</td>
          <td><input type="text" id="username" value="admin12345"/></td>
        </tr>
        <tr>
          <td>Password:</td>
          <td><input type="text" id="password" value="12345"/></td>
        </tr>
        <tr>
          <td><button id="login_button">Login</button></td>
          <td></td>
        </tr>
        <tr>
          <td>Obtained Token Value:</td>
          <td><input type="text" id="tokenvalue" /></td>
        </tr>
      </table>

      <table >
        <tr>
          <th colspan=2>Operations</th>
        </tr>
        <tr>
          <td>UserId:</td>
          <td><input type="text" id="userId" value="519331115K"/></td>
          <td>Get User...</td>
          <td><button id="fetch_info">Info</button></td>
          <td><button id="fetch_insuredPolicies">Insured Policies</button></td>
          <td><button id="fetch_objects">Objects</button></td>
          <td><button id="fetch_invoices">invoices</button></td>
        </tr>
      </table> 
      <div id="result"></div>
      <div id="userDataDetails">
          <textarea id="sendDtaDetails" rows="10" cols="100">
            At w3schools.com you will learn how to make a website. We offer free tutorials in all web development technologies.
          </textarea>
          <button id="update_button">update</button>
          <br> 
          <button id="create_button">Create</button> 
      </div> 

      <hr>
      Imagenes
      <input id="file" type="file"/> <button id="upload_button">Upload!!</button>

<button id="fetch_update">Fetch Update!!</button>

</body>

<script>

var stageURL = "https://99gbvdr12e.execute-api.us-west-2.amazonaws.com/Dev";
//var stageURL = "http://localhost:3000";
var tokenBearer; 

document.getElementById('login_button').addEventListener('click', function() {
      var username = $("input#username").val();
      var password = $("input#password").val();
      console.log(username+"/"+password);
      console.log(btoa(username + ":" + password));
      $.ajax({
          type:"POST", 
          url:stageURL+'/login', 
         //contentType: "application/json",
          headers: {
              'Authorization':'Basic '+btoa(username + ":" + password)
          },
          
          success: function (res){ 
            alert('success');
            $('#tokenvalue').val(res.token);
          },
          error: function (err){ 
            alert('error');
            alert(err.responseText);
          }
            //,dataType: 'json' // El tipo de datos esperados del servidor. Valor predeterminado: Intelligent Guess (xml, json, script, text, html).
      });
});


document.getElementById('fetch_info').addEventListener('click', function() {
  $('#result').val('Pending...');
  var url = stageURL+'/users/'+$('#userId').val();
  //alert(url);
    $.ajax({
      type: "GET",
      beforeSend: function(request) {
        request.setRequestHeader("Authorization", $('#tokenvalue').val())
      },
      url: url,
      //data: "json=" + escape(JSON.stringify(createRequestObject)),
      //processData: false,
      success: function(msg) {
        alert('ha ido bien')
        $('#result').text(JSON.stringify(msg, null, 2));
        //$("#results").append("The result =" + StringifyPretty(msg));
      },
      error: function(err){
        alert('ha ido mal '+err);
      }
    });
});


document.getElementById('update_button').addEventListener('click', function() {
  $('#result').val('Pending...');

  var url = stageURL+'/users/'+$('#userId').val();
  //alert(url);
    $.ajax({
      type: "PUT",
      beforeSend: function(request) {
        request.setRequestHeader("Authorization", $('#tokenvalue').val());
        request.setRequestHeader("Content-Type", 'application-json');
      },
      url: url,
      data: $('#sendDtaDetails').val(),
      //processData: false,
      success: function(msg) {
        alert('ha ido bien')
        $('#result').text(JSON.stringify(msg, null, 2));
        //$("#results").append("The result =" + StringifyPretty(msg));
      },
      error: function(err){
        alert('ha ido mal '+err);
      }
    });
});

document.getElementById('create_button').addEventListener('click', function() {
  $('#result').val('Pending...');

  var url = stageURL+'/users';
  //alert(url);
    $.ajax({
      type: "POST",
      beforeSend: function(request) {
        request.setRequestHeader("Authorization", $('#tokenvalue').val());
        request.setRequestHeader("Content-Type", 'application-json');
      },
      url: url,
      data: $('#sendDtaDetails').val(),
      //processData: false,
      success: function(msg) {
        alert('ha ido bien')
        $('#result').text(JSON.stringify(msg, null, 2));
        //$("#results").append("The result =" + StringifyPretty(msg));
      },
      error: function(err){
        alert('ha ido mal '+err);
      }
    });
});



document.getElementById('fetch_update').addEventListener('click', function() {
  $('#result').val('Pending...');
  var url = stageURL+'/upload';
  //alert(url);
    $.ajax({
      type: "GET",
      beforeSend: function(request) {
        request.setRequestHeader("Authorization", $('#tokenvalue').val())
      },
      url: url,
      //data: "json=" + escape(JSON.stringify(createRequestObject)),
      //processData: false,
      success: function(msg) {
        alert('ha ido bien')
        $('#result').text(JSON.stringify(msg, null, 2));
        //$("#results").append("The result =" + StringifyPretty(msg));
      },
      error: function(err){
        alert('ha ido mal '+err);
      }
    });
});




document.getElementById('upload_button').addEventListener('click', function() {
  
  readFile(function(){
      $('#result').val('Pending...');

        var url = '"https://8hvcpbqprk.execute-api.us-west-2.amazonaws.com/Prod'+'/upload2media';
        //alert(url);
          $.ajax({
            type: "POST",
            beforeSend: function(request) {
              request.setRequestHeader("Authorization", $('#tokenvalue').val());
              request.setRequestHeader("Content-Type", 'application-json');
            },
            url: url,
            data: $('#sendDtaDetails').val(),
            //processData: false,
            success: function(msg) {
              alert('ha ido bien')
              $('#result').text(JSON.stringify(msg, null, 2));
              //$("#results").append("The result =" + StringifyPretty(msg));
            },
            error: function(err){
              alert('ha ido mal '+err);
            }
          });
  });

  
});



function readFile(callback){
  var files = document.getElementById('file').files;
  if (files.length > 0) {
    var file = files[0];
     var reader = new FileReader();
     console.log('el file se llama ');
     console.log(file);

     reader.readAsDataURL(file);
     reader.onload = function () {
      console.log('ya he terminado1');
      //console.log(reader.result);
       console.log('ya he terminado2');
       console.log('en el 1 ');
       //console.log(reader.result);

       var uploadPayload={
        name:file.name,
        size:file.size,
        data:reader.result
       }

      callback(uploadPayload);

       // uploadFile(reader.result.split(',')[1]);
     };
     reader.onerror = function (error) {
      console.log('ya he terminado ERROR 1');
       console.log('Error: ', error);
       console.log('ya he terminado ERROR 2');
     };
  }
}



</script>
</html>